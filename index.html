<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>

    <!-- PWA: Manifest y tema -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Chat universal con m√∫ltiples modelos de IA - OpenRouter, OpenAI, Claude y m√°s">

    <!-- iOS: a√±adir a pantalla de inicio -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Chat">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192.png">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root{
            --primary:#6366f1; --primary-dark:#4f46e5;
            --bg-dark:#0f172a; --bg-secondary:#1e293b; --bg-tertiary:#334155;
            --text-primary:#f1f5f9; --text-secondary:#94a3b8; --border:#475569;
            --success:#10b981; --error:#ef4444; --warning:#f59e0b; --openrouter:#ff6b6b;
        }

        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
            background:linear-gradient(135deg,var(--bg-dark) 0%,#1a1f36 100%);
            color:var(--text-primary); height:100vh; display:flex; overflow:hidden;
        }

        .sidebar{ width:320px; background:var(--bg-secondary); border-right:1px solid var(--border); display:flex; flex-direction:column; transition:transform .3s ease; }
        .sidebar.collapsed{ transform:translateX(-320px); margin-right:-320px; }

        .sidebar-header{ padding:20px; border-bottom:1px solid var(--border); background:rgba(99,102,241,.1); }
        .sidebar-header h2{
            font-size:1.5rem; margin-bottom:10px;
            background:linear-gradient(135deg,var(--primary) 0%,#a78bfa 100%);
            background-clip:text; -webkit-background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
        }

        .model-selector{ padding:20px; border-bottom:1px solid var(--border); }
        .model-selector label{ display:block; margin-bottom:8px; font-size:.9rem; color:var(--text-secondary); }
        .model-selector select{
            width:100%; padding:10px; background:var(--bg-tertiary); color:var(--text-primary);
            border:1px solid var(--border); border-radius:8px; font-size:1rem; cursor:pointer; transition:all .3s ease;
        }
        .model-selector select:hover{ border-color:var(--primary); }

        .api-configs{ flex:1; overflow-y:auto; padding:20px; }

        .config-card{
            background:var(--bg-tertiary); border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid var(--border);
            transition:all .3s ease; animation:slideIn .3s ease;
        }
        @keyframes slideIn{ from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
        .config-card:hover{ border-color:var(--primary); box-shadow:0 4px 12px rgba(99,102,241,.2); }
        .config-card.openrouter:hover{ border-color:var(--openrouter); box-shadow:0 4px 12px rgba(255,107,107,.2); }

        .config-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .config-name{ font-weight:600; color:var(--primary); }
        .config-name.openrouter{ color:var(--openrouter); }

        .config-actions{ display:flex; gap:8px; }
        .btn-icon{ background:transparent; border:none; color:var(--text-secondary); cursor:pointer; padding:5px; border-radius:4px; transition:all .2s ease; }
        .btn-icon:hover{ color:var(--text-primary); background:rgba(99,102,241,.2); }
        .btn-icon.delete:hover{ color:var(--error); background:rgba(239,68,68,.2); }

        .add-config-btn{
            width:100%; padding:12px;
            background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:#fff; border:none; border-radius:8px; font-size:1rem; cursor:pointer; transition:all .3s ease; margin-bottom:15px; font-weight:600;
        }
        .add-config-btn:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(99,102,241,.4); }

        .main-content{ flex:1; display:flex; flex-direction:column; }

        .chat-header{
            padding:20px; border-bottom:1px solid var(--border); background:var(--bg-secondary);
            display:flex; justify-content:space-between; align-items:center;
        }
        .toggle-sidebar{ background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-primary); padding:8px 12px; border-radius:8px; cursor:pointer; transition:all .3s ease; }
        .toggle-sidebar:hover{ background:var(--primary); border-color:var(--primary); }

        .chat-container{ flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px; }

        .message{ display:flex; gap:12px; animation:fadeIn .3s ease; }
        @keyframes fadeIn{ from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
        .message.user{ flex-direction:row-reverse; }

        .message-avatar{ width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0; }
        .message.user .message-avatar{ background:linear-gradient(135deg,var(--primary) 0%,#a78bfa 100%) }
        .message.assistant .message-avatar{ background:linear-gradient(135deg,var(--success) 0%,#34d399 100%) }

        .message-content{ max-width:70%; padding:12px 16px; border-radius:12px; line-height:1.6; }
        .message.user .message-content{ background:var(--bg-tertiary); border:1px solid var(--border); }
        .message.assistant .message-content{ background:var(--bg-secondary); border:1px solid var(--border); }

        .message-content pre{ background:var(--bg-dark); padding:10px; border-radius:6px; overflow-x:auto; margin:10px 0; }
        .message-content code{ background:var(--bg-dark); padding:2px 6px; border-radius:4px; font-family:'Monaco','Consolas',monospace; font-size:.9em; }

        .typing-indicator{ display:flex; gap:4px; padding:15px; }
        .typing-dot{ width:8px; height:8px; background:var(--primary); border-radius:50%; animation:typing 1.4s ease-in-out infinite; }
        .typing-dot:nth-child(2){ animation-delay:.2s }
        .typing-dot:nth-child(3){ animation-delay:.4s }
        @keyframes typing{ 0%,60%,100%{ transform:translateY(0); opacity:.7 } 30%{ transform:translateY(-10px); opacity:1 } }

        .input-container{ padding:20px; border-top:1px solid var(--border); background:var(--bg-secondary); }
        .input-wrapper{ display:flex; gap:12px; align-items:flex-end; }

        .message-input{
            flex:1; padding:12px; background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border);
            border-radius:12px; font-size:1rem; resize:vertical; min-height:50px; max-height:200px; transition:all .3s ease;
        }
        .message-input:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1); }

        .send-button{
            padding:12px 24px; background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);
            color:#fff; border:none; border-radius:12px; font-size:1rem; cursor:pointer; transition:all .3s ease; font-weight:600;
        }
        .send-button:hover:not(:disabled){ transform:translateY(-2px); box-shadow:0 4px 12px rgba(99,102,241,.4); }
        .send-button:disabled{ opacity:.5; cursor:not-allowed; }

        .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(5px); z-index:1000; animation:fadeIn .3s ease; }
        .modal.active{ display:flex; align-items:center; justify-content:center; }
        .modal-content{
            background:var(--bg-secondary); border:1px solid var(--border); border-radius:16px;
            padding:30px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; animation:slideUp .3s ease;
        }
        @keyframes slideUp{ from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
        .modal-header{ margin-bottom:20px; }
        .modal-header h3{ font-size:1.5rem; margin-bottom:8px; }

        .form-group{ margin-bottom:20px; }
        .form-group label{ display:block; margin-bottom:8px; color:var(--text-secondary); font-size:.9rem; }
        .form-group input,.form-group select,.form-group textarea{
            width:100%; padding:10px; background:var(--bg-tertiary); color:var(--text-primary);
            border:1px solid var(--border); border-radius:8px; font-size:1rem; transition:all .3s ease;
        }
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{ outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1) }
        .form-group textarea{ resize:vertical; min-height:100px; font-family:'Monaco','Consolas',monospace; font-size:.9rem; }
        .form-group small { display:block; margin-top:5px; color:var(--text-secondary); font-size:.85rem; }

        .info-box{
            background:rgba(99,102,241,.1); border:1px solid var(--primary); color:var(--text-primary);
            padding:12px; border-radius:8px; margin-bottom:15px; font-size:.9rem;
        }
        .info-box.success { background:rgba(16,185,129,.1); border:1px solid var(--success); }
        .info-box a{ color:var(--primary); text-decoration:none; font-weight:600; }
        .info-box a:hover{ text-decoration:underline; }

        .examples-list{
            background:var(--bg-dark); padding:10px; border-radius:6px; margin-top:10px; font-size:.85rem; color:var(--text-secondary);
        }
        .examples-list strong{ color:var(--text-primary); }

        .modal-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:24px; }
        .btn{ padding:10px 20px; border:none; border-radius:8px; font-size:1rem; cursor:pointer; transition:all .3s ease; font-weight:600; }
        .btn-primary{ background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%); color:#fff; }
        .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 4px 12px rgba(99,102,241,.4); }
        .btn-secondary{ background:var(--bg-tertiary); color:var(--text-primary); border:1px solid var(--border); }
        .btn-secondary:hover{ background:var(--border); }

        .error-message{ background:rgba(239,68,68,.1); border:1px solid var(--error); color:var(--error); padding:12px; border-radius:8px; margin-bottom:15px; display:none; }
        .error-message.active{ display:block; animation:shake .3s ease; }
        @keyframes shake{ 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        .status-indicator{ display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }
        .status-indicator.active{ background:var(--success); animation:pulse 2s ease-in-out infinite; }
        .status-indicator.inactive{ background:var(--text-secondary); }
        @keyframes pulse{ 0%,100%{ box-shadow:0 0 0 0 rgba(16,185,129,.4)} 50%{ box-shadow:0 0 0 8px rgba(16,185,129,0)} }

        .badge-free{ display:inline-block; background:var(--success); color:#fff; padding:2px 6px; border-radius:4px; font-size:.75rem; margin-left:5px; font-weight:600; }

        @media (max-width:768px){
            .sidebar{ position:fixed; z-index:999; height:100% }
            .message-content{ max-width:85% }
            .modal-content{ width:95%; padding:20px }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ü§ñ Universal AI Chat</h2>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Conecta cualquier modelo de IA</p>
        </div>

        <div class="model-selector">
            <label for="activeModel">Modelo Activo</label>
            <select id="activeModel">
                <option value="">Selecciona un modelo</option>
            </select>
        </div>

        <div class="api-configs">
            <button class="add-config-btn" onclick="showAddModal()">+ A√±adir Nueva API</button>
            <div id="configsList"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞ Menu</button>
            <div style="display:flex; align-items:center;">
                <span class="status-indicator inactive" id="statusIndicator"></span>
                <span id="currentModelName">Sin modelo seleccionado</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div style="text-align:center; padding:50px; color:var(--text-secondary);">
                <h3 style="margin-bottom:20px; font-size:1.5rem;">¬°Bienvenido a Universal AI Chat!</h3>
                
                <div class="info-box success" style="max-width:500px; margin:20px auto; text-align:left;">
                    <strong>‚úÖ Tu Worker de Cloudflare est√° configurado</strong><br>
                    URL: <code>https://openrouter-proxy.juanjo-llopico.workers.dev</code><br>
                    Ahora solo necesitas a√±adir tus modelos favoritos.
                </div>

                <p>Para comenzar:</p>
                <ol style="text-align:left; max-width:400px; margin:20px auto; line-height:1.8;">
                    <li>Haz clic en "+ A√±adir Nueva API"</li>
                    <li>Selecciona "OpenRouter con Worker"</li>
                    <li>Elige tu modelo favorito</li>
                    <li>¬°Comienza a chatear!</li>
                </ol>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea class="message-input" id="messageInput" placeholder="Escribe tu mensaje aqu√≠..." onkeydown="handleKeyPress(event)"></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir/editar configuraci√≥n -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">A√±adir Nueva API</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Configura los detalles de tu API</p>
            </div>

            <div class="error-message" id="modalError"></div>
            <div class="info-box" id="providerInfo" style="display:none;"></div>

            <div class="form-group">
                <label for="configName">Nombre de la Configuraci√≥n</label>
                <input type="text" id="configName" placeholder="Ej: GPT-4o, Claude Sonnet, Qwen Coder">
                <small>Dale un nombre descriptivo para identificar este modelo</small>
            </div>

            <div class="form-group">
                <label for="provider">Proveedor</label>
                <select id="provider" onchange="updateProviderFields()">
                    <option value="openrouter-worker">OpenRouter con Worker (Recomendado)</option>
                    <option value="openrouter">OpenRouter Directo (requiere API key)</option>
                    <option value="openai">OpenAI Direct</option>
                    <option value="anthropic">Anthropic Direct</option>
                    <option value="groq">Groq Cloud</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>

            <div class="form-group" id="apiKeyGroup">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="sk-or-v1-... o sk-...">
                <small id="apiKeyHelp"></small>
            </div>

            <div class="form-group">
                <label for="modelName">ID del Modelo</label>
                <input type="text" id="modelName" placeholder="Ej: qwen/qwen-2.5-coder-32b-instruct:free">
                <small id="modelHelp"></small>
                <div class="examples-list" id="modelExamples" style="display:none;"></div>
            </div>

            <div class="form-group" id="endpointGroup" style="display:none;">
                <label for="endpoint">Endpoint URL</label>
                <input type="text" id="endpoint" placeholder="https://openrouter-proxy.juanjo-llopico.workers.dev">
                <small id="endpointHelp">URL del Worker o endpoint personalizado</small>
            </div>

            <div class="form-group" id="headersGroup" style="display:none;">
                <label for="customHeaders">Headers Personalizados (JSON)</label>
                <textarea id="customHeaders" placeholder='{"HTTP-Referer": "https://tu-app.com"}'></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n del Worker de Cloudflare
        const WORKER_URL = 'https://openrouter-proxy.juanjo-llopico.workers.dev';
        
        // Estado de la aplicaci√≥n
        let configs = [];
        let activeConfig = null;
        let messages = [];
        let editingConfigId = null;

        const modelExamples = {
            openrouter: {
                free: [
                    'qwen/qwen-2.5-coder-32b-instruct:free',
                    'google/gemini-2.0-flash-exp:free',
                    'meta-llama/llama-3.2-1b-instruct:free',
                    'microsoft/phi-3-mini-128k-instruct:free',
                    'liquid/lfm-40b:free'
                ],
                paid: [
                    'openai/gpt-4o',
                    'anthropic/claude-3.5-sonnet',
                    'google/gemini-pro-1.5',
                    'meta-llama/llama-3.3-70b-instruct'
                ]
            }
        };

        function init(){
            loadConfigs(); 
            renderConfigs(); 
            updateModelSelector();
            const savedActiveModel = localStorage.getItem('activeModelId');
            if (savedActiveModel){ 
                document.getElementById('activeModel').value = savedActiveModel; 
                setActiveModel(savedActiveModel); 
            }
        }

        function loadConfigs(){ 
            const saved = localStorage.getItem('aiConfigs'); 
            if (saved){ 
                configs = JSON.parse(saved); 
            } 
        }
        
        function saveConfigs(){ 
            localStorage.setItem('aiConfigs', JSON.stringify(configs)); 
        }

        function renderConfigs(){
            const container = document.getElementById('configsList');
            container.innerHTML = '';
            configs.forEach(config => {
                const card = document.createElement('div');
                const isOpenRouter = config.provider.includes('openrouter');
                const isFreeModel = config.model && config.model.includes(':free');
                card.className = `config-card ${isOpenRouter ? 'openrouter':''}`;
                card.innerHTML = `
                    <div class="config-header">
                        <span class="config-name ${isOpenRouter ? 'openrouter':''}">
                            ${config.name} ${isFreeModel ? '<span class="badge-free">GRATIS</span>':''}
                        </span>
                        <div class="config-actions">
                            <button class="btn-icon" onclick="editConfig('${config.id}')">‚úèÔ∏è</button>
                            <button class="btn-icon delete" onclick="deleteConfig('${config.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size:.85rem; color:var(--text-secondary);">
                        ${config.provider === 'openrouter-worker' ? 'OpenRouter (Worker)' : config.provider} | ${config.model}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateModelSelector(){
            const sel = document.getElementById('activeModel');
            sel.innerHTML = '<option value="">Selecciona un modelo</option>';
            configs.forEach(config => {
                const opt = document.createElement('option');
                opt.value = config.id;
                const isFree = config.model && config.model.includes(':free');
                opt.textContent = config.name + (isFree ? ' (GRATIS)' : '');
                sel.appendChild(opt);
            });
        }

        function toggleSidebar(){ 
            document.getElementById('sidebar').classList.toggle('collapsed'); 
        }

        function showAddModal(){
            editingConfigId = null;
            document.getElementById('modalTitle').textContent = 'A√±adir Nueva API';
            document.getElementById('configName').value = '';
            document.getElementById('provider').value = 'openrouter-worker';
            document.getElementById('apiKey').value = '';
            document.getElementById('modelName').value = 'qwen/qwen-2.5-coder-32b-instruct:free';
            document.getElementById('endpoint').value = WORKER_URL;
            document.getElementById('customHeaders').value = '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        function closeModal(){
            document.getElementById('configModal').classList.remove('active');
            document.getElementById('modalError').classList.remove('active');
        }

        function updateProviderFields(){
            const provider = document.getElementById('provider').value;
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const endpointGroup = document.getElementById('endpointGroup');
            const headersGroup = document.getElementById('headersGroup');
            const apiKeyHelp = document.getElementById('apiKeyHelp');
            const modelHelp = document.getElementById('modelHelp');
            const providerInfo = document.getElementById('providerInfo');
            const examplesDiv = document.getElementById('modelExamples');
            const endpointInput = document.getElementById('endpoint');

            if (provider === 'openrouter-worker'){
                providerInfo.className = 'info-box success';
                providerInfo.innerHTML = `
                    <strong>‚úÖ Worker Configurado</strong><br>
                    Tu Worker de Cloudflare ya tiene la API key configurada.<br>
                    Solo elige el modelo que quieras usar.
                `;
                providerInfo.style.display = 'block';
                
                apiKeyGroup.style.display = 'none';
                endpointGroup.style.display = 'block';
                endpointInput.value = WORKER_URL;
                endpointInput.disabled = true;
                headersGroup.style.display = 'none';
                
                modelHelp.textContent = 'Copia el ID exacto del modelo desde openrouter.ai/models';
                examplesDiv.innerHTML = `
                    <strong>Modelos Gratuitos:</strong><br>
                    ${modelExamples.openrouter.free.map(m => `‚Ä¢ ${m}`).join('<br>')}<br><br>
                    <strong>Modelos Premium:</strong><br>
                    ${modelExamples.openrouter.paid.map(m => `‚Ä¢ ${m}`).join('<br>')}
                `;
                examplesDiv.style.display = 'block';
                
            } else if (provider === 'openrouter'){
                providerInfo.className = 'info-box';
                providerInfo.innerHTML = `
                    <strong>OpenRouter Directo</strong><br>
                    Requiere API key. Obt√©n una en <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>
                `;
                providerInfo.style.display = 'block';
                
                apiKeyGroup.style.display = 'block';
                apiKeyHelp.textContent = 'Requerida para conexi√≥n directa';
                endpointGroup.style.display = 'none';
                headersGroup.style.display = 'none';
                
                modelHelp.textContent = 'Copia el ID exacto del modelo';
                examplesDiv.innerHTML = `
                    <strong>Modelos Gratuitos:</strong><br>
                    ${modelExamples.openrouter.free.map(m => `‚Ä¢ ${m}`).join('<br>')}<br><br>
                    <strong>Modelos Premium:</strong><br>
                    ${modelExamples.openrouter.paid.map(m => `‚Ä¢ ${m}`).join('<br>')}
                `;
                examplesDiv.style.display = 'block';
                
            } else if (provider === 'custom'){
                providerInfo.style.display = 'none';
                apiKeyGroup.style.display = 'block';
                apiKeyHelp.textContent = '';
                endpointGroup.style.display = 'block';
                endpointInput.disabled = false;
                endpointInput.value = '';
                headersGroup.style.display = 'block';
                modelHelp.textContent = '';
                examplesDiv.style.display = 'none';
                
            } else {
                providerInfo.style.display = 'none';
                apiKeyGroup.style.display = 'block';
                apiKeyHelp.textContent = '';
                endpointGroup.style.display = 'none';
                headersGroup.style.display = 'none';
                modelHelp.textContent = '';
                examplesDiv.style.display = 'none';
            }
        }

        function saveConfig(){
            const name = document.getElementById('configName').value.trim();
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const endpoint = document.getElementById('endpoint').value.trim();
            const customHeaders = document.getElementById('customHeaders').value.trim();

            if (!name || !model){
                showModalError('Por favor completa Nombre y Modelo.');
                return;
            }

            // Validaci√≥n seg√∫n el proveedor
            if (provider === 'openrouter' && !apiKey){
                showModalError('OpenRouter Directo requiere API key.');
                return;
            }
            
            if (provider !== 'openrouter-worker' && provider !== 'custom' && !apiKey){
                showModalError('Este proveedor requiere API key.');
                return;
            }

            if (customHeaders){
                try { JSON.parse(customHeaders); }
                catch(e) { showModalError('Los headers personalizados deben ser JSON v√°lido'); return; }
            }

            const config = {
                id: editingConfigId || generateId(),
                name,
                provider,
                apiKey,
                model,
                endpoint: endpoint || (provider === 'openrouter-worker' ? WORKER_URL : ''),
                customHeaders: customHeaders ? JSON.parse(customHeaders) : {}
            };

            if (editingConfigId){
                const idx = configs.findIndex(c => c.id === editingConfigId);
                configs[idx] = config;
            } else {
                configs.push(config);
            }

            saveConfigs();
            renderConfigs();
            updateModelSelector();
            closeModal();

            // Activar autom√°ticamente si es la primera
            if (configs.length === 1){
                document.getElementById('activeModel').value = config.id;
                setActiveModel(config.id);
            }
        }

        function editConfig(id){
            const config = configs.find(c => c.id === id);
            if (!config) return;
            
            editingConfigId = id;
            document.getElementById('modalTitle').textContent = 'Editar Configuraci√≥n';
            document.getElementById('configName').value = config.name;
            document.getElementById('provider').value = config.provider;
            document.getElementById('apiKey').value = config.apiKey || '';
            document.getElementById('modelName').value = config.model;
            document.getElementById('endpoint').value = config.endpoint || '';
            document.getElementById('customHeaders').value = config.customHeaders ? JSON.stringify(config.customHeaders, null, 2) : '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        function deleteConfig(id){
            if (!confirm('¬øEst√°s seguro de eliminar esta configuraci√≥n?')) return;
            configs = configs.filter(c => c.id !== id);
            saveConfigs();
            renderConfigs();
            updateModelSelector();
            if (activeConfig && activeConfig.id === id){
                activeConfig = null;
                document.getElementById('activeModel').value = '';
                updateStatus();
            }
        }

        function setActiveModel(configId){
            if (!configId){
                activeConfig = null;
                updateStatus();
                return;
            }
            activeConfig = configs.find(c => c.id === configId);
            localStorage.setItem('activeModelId', configId);
            updateStatus();
        }

        function updateStatus(){
            const indicator = document.getElementById('statusIndicator');
            const modelName = document.getElementById('currentModelName');
            if (activeConfig){
                indicator.className = 'status-indicator active';
                const isFree = activeConfig.model && activeConfig.model.includes(':free');
                modelName.textContent = activeConfig.name + (isFree ? ' (GRATIS)' : '');
            } else {
                indicator.className = 'status-indicator inactive';
                modelName.textContent = 'Sin modelo seleccionado';
            }
        }

        document.getElementById('activeModel').addEventListener('change', e => setActiveModel(e.target.value));

        function handleKeyPress(e){
            if (e.key === 'Enter' && !e.shiftKey){
                e.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage(){
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            if (!activeConfig){
                alert('Por favor selecciona un modelo activo primero');
                return;
            }

            addMessage('user', message);
            input.value = '';

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            showTypingIndicator();

            try {
                const response = await callAPI(message);
                removeTypingIndicator();
                addMessage('assistant', response);
            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
            }
        }

        async function callAPI(message){
            const config = activeConfig;
            let url, headers, body;

            // Configurar seg√∫n el proveedor
            if (config.provider === 'openrouter-worker') {
                // Usar el Worker de Cloudflare
                url = config.endpoint || WORKER_URL;
                headers = {
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Universal AI Chat'
                };
                body = {
                    model: config.model,
                    messages: messages.concat([{ role: 'user', content: message }])
                };
                
            } else if (config.provider === 'openrouter') {
                // OpenRouter directo (puede fallar por CORS)
                url = 'https://openrouter.ai/api/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`,
                    'HTTP-Referer': window.location.href,
                    'X-Title': 'Universal AI Chat'
                };
                body = {
                    model: config.model,
                    messages: messages.concat([{ role: 'user', content: message }])
                };
                
            } else if (config.provider === 'openai') {
                url = 'https://api.openai.com/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                };
                body = {
                    model: config.model,
                    messages: messages.concat([{ role: 'user', content: message }])
                };
                
            } else if (config.provider === 'groq') {
                url = 'https://api.groq.com/openai/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.apiKey}`
                };
                body = {
                    model: config.model,
                    messages: messages.concat([{ role: 'user', content: message }])
                };
                
            } else if (config.provider === 'custom') {
                url = config.endpoint;
                headers = {
                    'Content-Type': 'application/json',
                    ...config.customHeaders
                };
                if (!headers.Authorization && config.apiKey) {
                    headers.Authorization = `Bearer ${config.apiKey}`;
                }
                body = {
                    model: config.model,
                    messages: messages.concat([{ role: 'user', content: message }])
                };
            }

            // Hacer la petici√≥n
            const response = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage = errorText;
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.error?.message || errorJson.message || errorText;
                } catch {}
                
                if (response.status === 401) {
                    throw new Error('API key inv√°lida o faltante. Verifica tu configuraci√≥n.');
                } else if (response.status === 429) {
                    throw new Error('L√≠mite de rate excedido. Espera un momento o usa otro modelo.');
                } else if (response.status === 0 || errorMessage.includes('Failed to fetch')) {
                    throw new Error('Error de CORS. Si usas OpenRouter, configura el Worker primero.');
                }
                
                throw new Error(`Error ${response.status}: ${errorMessage}`);
            }

            const data = await response.json();
            
            // Extraer la respuesta seg√∫n el formato
            let content = data.choices?.[0]?.message?.content || 
                         data.content?.[0]?.text || 
                         data.candidates?.[0]?.content?.parts?.[0]?.text ||
                         'Sin respuesta';

            // Actualizar historial
            messages.push(
                { role: 'user', content: message },
                { role: 'assistant', content }
            );

            return content;
        }

        function addMessage(role, content){
            const container = document.getElementById('chatContainer');
            const intro = container.querySelector('div[style*="text-align: center"]');
            if (intro) intro.remove();
            
            const d = document.createElement('div');
            d.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';
            
            const c = document.createElement('div');
            c.className = 'message-content';
            c.innerHTML = formatMessage(content);
            
            d.appendChild(avatar);
            d.appendChild(c);
            container.appendChild(d);
            container.scrollTop = container.scrollHeight;
        }

        function formatMessage(content){
            content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            content = content.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');
            content = content.replace(/\n/g, '<br>');
            return content;
        }

        function showTypingIndicator(){
            const container = document.getElementById('chatContainer');
            const ind = document.createElement('div');
            ind.className = 'message assistant';
            ind.id = 'typingIndicator';
            ind.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>`;
            container.appendChild(ind);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator(){
            const ind = document.getElementById('typingIndicator');
            if (ind) ind.remove();
        }

        function showModalError(msg){
            const e = document.getElementById('modalError');
            e.textContent = msg;
            e.classList.add('active');
            setTimeout(() => e.classList.remove('active'), 5000);
        }

        function generateId(){
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        document.addEventListener('DOMContentLoaded', init);

        // Service Worker
        if ('serviceWorker' in navigator){
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado'))
                    .catch(err => console.error('SW error:', err));
            });
        }
    </script>
</body>
</html>
