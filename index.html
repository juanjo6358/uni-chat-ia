<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Chat</title>

    <!-- PWA: Manifest y tema -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">

    <!-- iOS: a√±adir a pantalla de inicio -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Chat">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f36 100%);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-320px);
            margin-right: -320px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(99, 102, 241, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .model-selector {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .model-selector label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-selector select:hover {
            border-color: var(--primary);
        }

        .api-configs {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .config-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 15px; /* FIX: antes pon√≠a 15swept */
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-name {
            font-weight: 600;
            color: var(--primary);
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.2);
        }

        .btn-icon.delete:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.2);
        }

        .add-config-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .add-config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-sidebar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-sidebar:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { flex-direction: row-reverse; }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .message.assistant .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .message-content pre {
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            min-height: 50px;
            max-height: 200px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .send-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 1000; animation: fadeIn 0.3s ease;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

        .modal-header { margin-bottom: 20px; }
        .modal-header h3 { font-size: 1.5rem; margin-bottom: 8px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-group textarea { resize: vertical; min-height: 100px; font-family: 'Monaco','Consolas',monospace; font-size: 0.9rem; }

        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        .error-message {
            background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error);
            padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none;
        }
        .error-message.active { display: block; animation: shake 0.3s ease; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }
        .status-indicator.active { background: var(--success); animation: pulse 2s ease-in-out infinite; }
        .status-indicator.inactive { background: var(--text-secondary); }
        @keyframes pulse { 0%,100%{ box-shadow:0 0 0 0 rgba(16,185,129,0.4)} 50%{ box-shadow:0 0 0 8px rgba(16,185,129,0)} }

        @media (max-width: 768px) {
            .sidebar { position: fixed; z-index: 999; height: 100%; }
            .message-content { max-width: 85%; }
            .modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ü§ñ Universal AI Chat</h2>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Conecta cualquier modelo de IA</p>
        </div>

        <div class="model-selector">
            <label for="activeModel">Modelo Activo</label>
            <select id="activeModel">
                <option value="">Selecciona un modelo</option>
            </select>
        </div>

        <div class="api-configs">
            <button class="add-config-btn" onclick="showAddModal()">+ A√±adir Nueva API</button>
            <div id="configsList"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞ Menu</button>
            <div style="display: flex; align-items: center;">
                <span class="status-indicator inactive" id="statusIndicator"></span>
                <span id="currentModelName">Sin modelo seleccionado</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                <h3 style="margin-bottom: 20px; font-size: 1.5rem;">¬°Bienvenido a Universal AI Chat!</h3>
                <p>Para comenzar:</p>
                <ol style="text-align: left; max-width: 400px; margin: 20px auto; line-height: 1.8;">
                    <li>Haz clic en "+ A√±adir Nueva API" en el panel lateral</li>
                    <li>Configura tu proveedor de IA preferido</li>
                    <li>Selecciona el modelo activo</li>
                    <li>¬°Comienza a chatear!</li>
                </ol>
                <p style="margin-top: 30px; font-size: 0.9rem;">
                    Compatible con: OpenAI, Anthropic, Google AI, Groq, y m√°s...
                </p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Escribe tu mensaje aqu√≠..."
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir/editar configuraci√≥n -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">A√±adir Nueva API</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Configura los detalles de tu API</p>
            </div>

            <div class="error-message" id="modalError"></div>

            <div class="form-group">
                <label for="configName">Nombre de la Configuraci√≥n</label>
                <input type="text" id="configName" placeholder="Mi API de OpenAI">
            </div>

            <div class="form-group">
                <label for="provider">Proveedor</label>
                <select id="provider" onchange="updateProviderFields()">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="google">Google AI (Gemini)</option>
                    <option value="groq">Groq</option>
                    <option value="together">Together AI</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>

            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="sk-...">
            </div>

            <div class="form-group">
                <label for="modelName">Modelo</label>
                <input type="text" id="modelName" placeholder="gpt-4-turbo-preview">
            </div>

            <div class="form-group" id="endpointGroup" style="display: none;">
                <label for="endpoint">Endpoint URL</label>
                <input type="text" id="endpoint" placeholder="https://api.openai.com/v1/chat/completions">
            </div>

            <div class="form-group" id="headersGroup" style="display: none;">
                <label for="customHeaders">Headers Personalizados (JSON)</label>
                <textarea id="customHeaders" placeholder='{"Authorization": "Bearer YOUR_KEY"}'></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let configs = [];
        let activeConfig = null;
        let messages = [];
        let editingConfigId = null;

        // Endpoints predefinidos para proveedores comunes
        const providerEndpoints = {
            openai: 'https://api.openai.com/v1/chat/completions',
            anthropic: 'https://api.anthropic.com/v1/messages',
            google: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',
            groq: 'https://api.groq.com/openai/v1/chat/completions',
            together: 'https://api.together.xyz/v1/chat/completions'
        };

        // Modelos sugeridos por proveedor
        const suggestedModels = {
            openai: 'gpt-4-turbo-preview',
            anthropic: 'claude-3-opus-20240229',
            google: 'gemini-1.5-pro-latest',
            groq: 'llama3-70b-8192',
            together: 'meta-llama/Llama-3-70b-chat-hf'
        };

        // Inicializar la aplicaci√≥n
        function init() {
            loadConfigs();
            renderConfigs();
            updateModelSelector();
            
            // Restaurar el modelo activo si existe
            const savedActiveModel = localStorage.getItem('activeModelId');
            if (savedActiveModel) {
                document.getElementById('activeModel').value = savedActiveModel;
                setActiveModel(savedActiveModel);
            }
        }

        // Cargar configuraciones desde localStorage
        function loadConfigs() {
            const saved = localStorage.getItem('aiConfigs');
            if (saved) {
                configs = JSON.parse(saved);
            }
        }

        // Guardar configuraciones en localStorage
        function saveConfigs() {
            localStorage.setItem('aiConfigs', JSON.stringify(configs));
        }

        // Renderizar lista de configuraciones
        function renderConfigs() {
            const container = document.getElementById('configsList');
            container.innerHTML = '';

            configs.forEach(config => {
                const card = document.createElement('div');
                card.className = 'config-card';
                card.innerHTML = `
                    <div class="config-header">
                        <span class="config-name">${config.name}</span>
                        <div class="config-actions">
                            <button class="btn-icon" onclick="editConfig('${config.id}')">‚úèÔ∏è</button>
                            <button class="btn-icon delete" onclick="deleteConfig('${config.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${config.provider} | ${config.model}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Actualizar selector de modelos
        function updateModelSelector() {
            const selector = document.getElementById('activeModel');
            selector.innerHTML = '<option value="">Selecciona un modelo</option>';

            configs.forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = config.name;
                selector.appendChild(option);
            });
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Mostrar modal de a√±adir/editar
        function showAddModal() {
            editingConfigId = null;
            document.getElementById('modalTitle').textContent = 'A√±adir Nueva API';
            document.getElementById('configName').value = '';
            document.getElementById('provider').value = 'openai';
            document.getElementById('apiKey').value = '';
            document.getElementById('modelName').value = suggestedModels.openai;
            document.getElementById('endpoint').value = '';
            document.getElementById('customHeaders').value = '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('configModal').classList.remove('active');
            document.getElementById('modalError').classList.remove('active');
        }

        // Actualizar campos seg√∫n el proveedor
        function updateProviderFields() {
            const provider = document.getElementById('provider').value;
            const endpointGroup = document.getElementById('endpointGroup');
            const headersGroup = document.getElementById('headersGroup');
            const modelInput = document.getElementById('modelName');

            if (provider === 'custom') {
                endpointGroup.style.display = 'block';
                headersGroup.style.display = 'block';
            } else {
                endpointGroup.style.display = 'none';
                headersGroup.style.display = 'none';
                if (!editingConfigId && suggestedModels[provider]) {
                    modelInput.value = suggestedModels[provider];
                }
            }
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            const name = document.getElementById('configName').value.trim();
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const endpoint = document.getElementById('endpoint').value.trim();
            const customHeaders = document.getElementById('customHeaders').value.trim();

            // Validaci√≥n
            if (!name || !apiKey || !model) {
                showModalError('Por favor completa todos los campos requeridos');
                return;
            }

            // Validar JSON de headers si es custom
            if (provider === 'custom' && customHeaders) {
                try { JSON.parse(customHeaders); }
                catch (e) { showModalError('Los headers personalizados deben ser JSON v√°lido'); return; }
            }

            const config = {
                id: editingConfigId || generateId(),
                name,
                provider,
                apiKey,
                model,
                endpoint: endpoint || providerEndpoints[provider],
                customHeaders: customHeaders ? JSON.parse(customHeaders) : {}
            };

            if (editingConfigId) {
                const index = configs.findIndex(c => c.id === editingConfigId);
                configs[index] = config;
            } else {
                configs.push(config);
            }

            saveConfigs();
            renderConfigs();
            updateModelSelector();
            closeModal();
        }

        // Editar configuraci√≥n
        function editConfig(id) {
            const config = configs.find(c => c.id === id);
            if (!config) return;

            editingConfigId = id;
            document.getElementById('modalTitle').textContent = 'Editar Configuraci√≥n';
            document.getElementById('configName').value = config.name;
            document.getElementById('provider').value = config.provider;
            document.getElementById('apiKey').value = config.apiKey;
            document.getElementById('modelName').value = config.model;
            document.getElementById('endpoint').value = config.endpoint || '';
            document.getElementById('customHeaders').value = config.customHeaders ? JSON.stringify(config.customHeaders, null, 2) : '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        // Eliminar configuraci√≥n
        function deleteConfig(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta configuraci√≥n?')) return;

            configs = configs.filter(c => c.id !== id);
            saveConfigs();
            renderConfigs();
            updateModelSelector();

            if (activeConfig && activeConfig.id === id) {
                activeConfig = null;
                document.getElementById('activeModel').value = '';
                updateStatus();
            }
        }

        // Establecer modelo activo
        function setActiveModel(configId) {
            if (!configId) {
                activeConfig = null;
                updateStatus();
                return;
            }

            activeConfig = configs.find(c => c.id === configId);
            localStorage.setItem('activeModelId', configId);
            updateStatus();
        }

        // Actualizar indicador de estado
        function updateStatus() {
            const indicator = document.getElementById('statusIndicator');
            const modelName = document.getElementById('currentModelName');

            if (activeConfig) {
                indicator.className = 'status-indicator active';
                modelName.textContent = activeConfig.name;
            } else {
                indicator.className = 'status-indicator inactive';
                modelName.textContent = 'Sin modelo seleccionado';
            }
        }

        // Event listener para cambio de modelo
        document.getElementById('activeModel').addEventListener('change', (e) => {
            setActiveModel(e.target.value);
        });

        // Manejar tecla Enter en el input
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            if (!activeConfig) {
                alert('Por favor selecciona un modelo activo primero');
                return;
            }

            // A√±adir mensaje del usuario
            addMessage('user', message);
            input.value = '';

            // Deshabilitar el bot√≥n de enviar
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            // Mostrar indicador de escritura
            showTypingIndicator();

            try {
                const response = await callAPI(message);
                removeTypingIndicator();
                addMessage('assistant', response);
            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
            }
        }

        // Llamar a la API
        async function callAPI(message) {
            const config = activeConfig;

            // Preparar el cuerpo de la petici√≥n seg√∫n el proveedor
            let body, headers, url;

            switch (config.provider) {
                case 'anthropic':
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': config.apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }]),
                        max_tokens: 1024
                    };
                    break;

                case 'google':
                    url = config.endpoint.replace('{model}', config.model) + '?key=' + config.apiKey;
                    headers = { 'Content-Type': 'application/json' };
                    body = { contents: [{ parts: [{ text: message }] }] };
                    break;

                case 'custom':
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        ...config.customHeaders
                    };
                    if (!headers.Authorization && config.apiKey) {
                        headers.Authorization = `Bearer ${config.apiKey}`;
                    }
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }])
                    };
                    break;

                default: // openai, groq, together
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    };
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }])
                    };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`API Error (${response.status}): ${error}`);
                }

                const data = await response.json();

                // Extraer la respuesta seg√∫n el formato del proveedor
                let content;
                switch (config.provider) {
                    case 'anthropic':
                        content = data.content[0].text;
                        break;
                    case 'google':
                        content = data.candidates[0].content.parts[0].text;
                        break;
                    default:
                        content = data.choices[0].message.content;
                }

                // Actualizar historial de mensajes
                messages.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content }
                );

                return content;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // A√±adir mensaje al chat
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Formatear mensaje (Markdown b√°sico)
        function formatMessage(content) {
            content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');      // Escapar HTML
            content = content.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>'); // Code blocks
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');                     // Inline code
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');            // Bold
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');                        // Italic
            content = content.replace(/\n/g, '<br>');                                      // Line breaks
            return content;
        }

        // Indicador de escritura
        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function showModalError(message) {
            const errorDiv = document.getElementById('modalError');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => errorDiv.classList.remove('active'), 5000);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <!-- Registro del Service Worker + aviso de actualizaci√≥n -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => {
              if (reg.waiting) promptUpdate(reg);
              reg.addEventListener('updatefound', () => {
                const newSW = reg.installing;
                if (!newSW) return;
                newSW.addEventListener('statechange', () => {
                  if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                    promptUpdate(reg);
                  }
                });
              });
            })
            .catch(err => console.error('SW registration failed:', err));
        });
      }

      function promptUpdate(reg) {
        const bar = document.createElement('div');
        bar.style.cssText = `
          position:fixed;left:50%;transform:translateX(-50%);bottom:16px;
          background:#1e293b;color:#fff;border:1px solid #475569;border-radius:12px;
          padding:10px 14px;display:flex;gap:10px;align-items:center;z-index:9999;`;
        bar.innerHTML = `
          <span>Nueva versi√≥n disponible</span>
          <button style="background:#6366f1;border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;">
            Actualizar
          </button>`;
        bar.querySelector('button').onclick = () => {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        };
        document.body.appendChild(bar);

        navigator.serviceWorker.addEventListener('controllerchange', () => {
          location.reload();
        });
      }
    </script>
</body>
</html>