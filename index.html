<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>

    <!-- PWA: Manifest y tema -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="description" content="Chat universal con m√∫ltiples modelos de IA - OpenRouter, OpenAI, Claude y m√°s">

    <!-- iOS: a√±adir a pantalla de inicio -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI Chat">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-dark: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --openrouter: #ff6b6b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1f36 100%);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-320px);
            margin-right: -320px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(99, 102, 241, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        .model-selector {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .model-selector label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .model-selector select {
            width: 100%;
            padding: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-selector select:hover {
            border-color: var(--primary);
        }

        .api-configs {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .config-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .config-card.openrouter:hover {
            border-color: var(--openrouter);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);
        }

        .config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .config-name {
            font-weight: 600;
            color: var(--primary);
        }

        .config-name.openrouter {
            color: var(--openrouter);
        }

        .config-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            color: var(--text-primary);
            background: rgba(99, 102, 241, 0.2);
        }

        .btn-icon.delete:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.2);
        }

        .add-config-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .add-config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .quick-add-openrouter {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--openrouter) 0%, #ff5252 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .quick-add-openrouter:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toggle-sidebar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-sidebar:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user { flex-direction: row-reverse; }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, #a78bfa 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, var(--success) 0%, #34d399 100%);
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .message.assistant .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
        }

        .message-content pre {
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 15px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            resize: vertical;
            min-height: 50px;
            max-height: 200px;
            transition: all 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .send-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        .send-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            z-index: 1000; animation: fadeIn 0.3s ease;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }

        .modal-header { margin-bottom: 20px; }
        .modal-header h3 { font-size: 1.5rem; margin-bottom: 8px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; background: var(--bg-tertiary); color: var(--text-primary);
            border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; transition: all 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        .form-group textarea { resize: vertical; min-height: 100px; font-family: 'Monaco','Consolas',monospace; font-size: 0.9rem; }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }

        .error-message {
            background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error);
            padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none;
        }
        .error-message.active { display: block; animation: shake 0.3s ease; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .info-box a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .info-box a:hover {
            text-decoration: underline;
        }

        .status-indicator { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:8px; }
        .status-indicator.active { background: var(--success); animation: pulse 2s ease-in-out infinite; }
        .status-indicator.inactive { background: var(--text-secondary); }
        @keyframes pulse { 0%,100%{ box-shadow:0 0 0 0 rgba(16,185,129,0.4)} 50%{ box-shadow:0 0 0 8px rgba(16,185,129,0)} }

        .badge-free {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 5px;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .sidebar { position: fixed; z-index: 999; height: 100%; }
            .message-content { max-width: 85%; }
            .modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>ü§ñ Universal AI Chat</h2>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">Conecta cualquier modelo de IA</p>
        </div>

        <div class="model-selector">
            <label for="activeModel">Modelo Activo</label>
            <select id="activeModel">
                <option value="">Selecciona un modelo</option>
            </select>
        </div>

        <div class="api-configs">
            <button class="quick-add-openrouter" onclick="showOpenRouterQuickSetup()">üöÄ Config R√°pida OpenRouter</button>
            <button class="add-config-btn" onclick="showAddModal()">+ A√±adir Nueva API</button>
            <div id="configsList"></div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-header">
            <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞ Menu</button>
            <div style="display: flex; align-items: center;">
                <span class="status-indicator inactive" id="statusIndicator"></span>
                <span id="currentModelName">Sin modelo seleccionado</span>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                <h3 style="margin-bottom: 20px; font-size: 1.5rem;">¬°Bienvenido a Universal AI Chat!</h3>
                <p style="margin-bottom: 20px;">Para comenzar r√°pidamente:</p>
                <button class="quick-add-openrouter" onclick="showOpenRouterQuickSetup()" style="margin: 0 auto 20px;">
                    üöÄ Configurar OpenRouter (Modelos Gratis)
                </button>
                <p>O configura manualmente:</p>
                <ol style="text-align: left; max-width: 400px; margin: 20px auto; line-height: 1.8;">
                    <li>Haz clic en "+ A√±adir Nueva API" en el panel lateral</li>
                    <li>Configura tu proveedor de IA preferido</li>
                    <li>Selecciona el modelo activo</li>
                    <li>¬°Comienza a chatear!</li>
                </ol>
                <p style="margin-top: 30px; font-size: 0.9rem;">
                    Compatible con: OpenRouter, OpenAI, Anthropic, Google AI, Groq, y m√°s...
                </p>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Escribe tu mensaje aqu√≠..."
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    Enviar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para a√±adir/editar configuraci√≥n -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">A√±adir Nueva API</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Configura los detalles de tu API</p>
            </div>

            <div class="error-message" id="modalError"></div>

            <div class="form-group">
                <label for="configName">Nombre de la Configuraci√≥n</label>
                <input type="text" id="configName" placeholder="Mi API de OpenRouter">
            </div>

            <div class="form-group">
                <label for="provider">Proveedor</label>
                <select id="provider" onchange="updateProviderFields()">
                    <option value="openrouter">OpenRouter (M√∫ltiples Modelos)</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic (Claude)</option>
                    <option value="google">Google AI (Gemini)</option>
                    <option value="groq">Groq</option>
                    <option value="together">Together AI</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>

            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="password" id="apiKey" placeholder="sk-or-v1-...">
                <small id="apiKeyHelp">Para OpenRouter: obt√©n tu key en <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a></small>
            </div>

            <div class="form-group">
                <label for="modelName">Modelo</label>
                <input type="text" id="modelName" placeholder="qwen/qwen-3-coder:free">
                <small id="modelHelp">Ejemplos: qwen/qwen-3-coder:free, meta-llama/llama-3.3-70b-instruct, google/gemini-flash-1.5</small>
            </div>

            <div class="form-group" id="endpointGroup" style="display: none;">
                <label for="endpoint">Endpoint URL</label>
                <input type="text" id="endpoint" placeholder="https://openrouter.ai/api/v1/chat/completions">
            </div>

            <div class="form-group" id="headersGroup" style="display: none;">
                <label for="customHeaders">Headers Personalizados (JSON)</label>
                <textarea id="customHeaders" placeholder='{"HTTP-Referer": "https://tu-app.com", "X-Title": "Mi App"}'></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveConfig()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de configuraci√≥n r√°pida de OpenRouter -->
    <div class="modal" id="openrouterQuickModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöÄ Configuraci√≥n R√°pida de OpenRouter</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Accede a modelos gratuitos y de pago con una sola API</p>
            </div>

            <div class="info-box">
                <strong>¬øQu√© es OpenRouter?</strong><br>
                OpenRouter te da acceso a m√∫ltiples modelos de IA (GPT-4, Claude, Llama, etc.) con una sola API key.
                Incluye modelos gratuitos como Qwen-3-Coder y Google Gemini Flash.
            </div>

            <div class="form-group">
                <label for="quickApiKey">Tu API Key de OpenRouter</label>
                <input type="password" id="quickApiKey" placeholder="sk-or-v1-...">
                <small>¬øNo tienes key? <a href="https://openrouter.ai/keys" target="_blank">Obt√©n una gratis aqu√≠</a></small>
            </div>

            <div class="form-group">
                <label>Elige un modelo para empezar:</label>
                <select id="quickModel">
                    <optgroup label="üÜì Modelos Gratuitos">
                        <option value="qwen/qwen-2.5-coder-32b-instruct:free">Qwen 2.5 Coder 32B (Gratis) - Programaci√≥n</option>
                        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Gratis) - General</option>
                        <option value="meta-llama/llama-3.2-1b-instruct:free">Llama 3.2 1B (Gratis) - R√°pido</option>
                        <option value="microsoft/phi-3-mini-128k-instruct:free">Phi-3 Mini (Gratis) - Eficiente</option>
                        <option value="huggingfaceh4/zephyr-7b-beta:free">Zephyr 7B (Gratis) - Chat</option>
                    </optgroup>
                    <optgroup label="üíé Modelos Premium">
                        <option value="openai/gpt-4o">GPT-4o - M√°s Avanzado</option>
                        <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet - Creativo</option>
                        <option value="google/gemini-pro-1.5">Gemini Pro 1.5 - Contexto Largo</option>
                        <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B - Open Source</option>
                    </optgroup>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeQuickModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveQuickOpenRouter()">Configurar y Empezar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let configs = [];
        let activeConfig = null;
        let messages = [];
        let editingConfigId = null;

        // Endpoints predefinidos para proveedores comunes
        const providerEndpoints = {
            openrouter: 'https://openrouter.ai/api/v1/chat/completions',
            openai: 'https://api.openai.com/v1/chat/completions',
            anthropic: 'https://api.anthropic.com/v1/messages',
            google: 'https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent',
            groq: 'https://api.groq.com/openai/v1/chat/completions',
            together: 'https://api.together.xyz/v1/chat/completions'
        };

        // Modelos sugeridos por proveedor
        const suggestedModels = {
            openrouter: 'qwen/qwen-2.5-coder-32b-instruct:free',
            openai: 'gpt-4-turbo-preview',
            anthropic: 'claude-3-opus-20240229',
            google: 'gemini-1.5-pro-latest',
            groq: 'llama3-70b-8192',
            together: 'meta-llama/Llama-3-70b-chat-hf'
        };

        // Inicializar la aplicaci√≥n
        function init() {
            loadConfigs();
            renderConfigs();
            updateModelSelector();
            
            // Restaurar el modelo activo si existe
            const savedActiveModel = localStorage.getItem('activeModelId');
            if (savedActiveModel) {
                document.getElementById('activeModel').value = savedActiveModel;
                setActiveModel(savedActiveModel);
            }
        }

        // Cargar configuraciones desde localStorage
        function loadConfigs() {
            const saved = localStorage.getItem('aiConfigs');
            if (saved) {
                configs = JSON.parse(saved);
            }
        }

        // Guardar configuraciones en localStorage
        function saveConfigs() {
            localStorage.setItem('aiConfigs', JSON.stringify(configs));
        }

        // Renderizar lista de configuraciones
        function renderConfigs() {
            const container = document.getElementById('configsList');
            container.innerHTML = '';

            configs.forEach(config => {
                const card = document.createElement('div');
                const isOpenRouter = config.provider === 'openrouter';
                const isFreeModel = config.model && config.model.includes(':free');
                
                card.className = `config-card ${isOpenRouter ? 'openrouter' : ''}`;
                card.innerHTML = `
                    <div class="config-header">
                        <span class="config-name ${isOpenRouter ? 'openrouter' : ''}">
                            ${config.name}
                            ${isFreeModel ? '<span class="badge-free">GRATIS</span>' : ''}
                        </span>
                        <div class="config-actions">
                            <button class="btn-icon" onclick="editConfig('${config.id}')">‚úèÔ∏è</button>
                            <button class="btn-icon delete" onclick="deleteConfig('${config.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${config.provider} | ${config.model}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Actualizar selector de modelos
        function updateModelSelector() {
            const selector = document.getElementById('activeModel');
            selector.innerHTML = '<option value="">Selecciona un modelo</option>';

            configs.forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                const isFree = config.model && config.model.includes(':free');
                option.textContent = config.name + (isFree ? ' (GRATIS)' : '');
                selector.appendChild(option);
            });
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Mostrar modal de configuraci√≥n r√°pida de OpenRouter
        function showOpenRouterQuickSetup() {
            document.getElementById('openrouterQuickModal').classList.add('active');
        }

        // Cerrar modal r√°pido
        function closeQuickModal() {
            document.getElementById('openrouterQuickModal').classList.remove('active');
        }

        // Guardar configuraci√≥n r√°pida de OpenRouter
        function saveQuickOpenRouter() {
            const apiKey = document.getElementById('quickApiKey').value.trim();
            const model = document.getElementById('quickModel').value;
            
            if (!apiKey) {
                alert('Por favor ingresa tu API key de OpenRouter');
                return;
            }

            const modelName = document.getElementById('quickModel').options[document.getElementById('quickModel').selectedIndex].text;
            const configName = modelName.split(' - ')[0];

            const config = {
                id: generateId(),
                name: `OpenRouter - ${configName}`,
                provider: 'openrouter',
                apiKey: apiKey,
                model: model,
                endpoint: providerEndpoints.openrouter,
                customHeaders: {}
            };

            configs.push(config);
            saveConfigs();
            renderConfigs();
            updateModelSelector();
            
            // Activar autom√°ticamente el modelo reci√©n a√±adido
            document.getElementById('activeModel').value = config.id;
            setActiveModel(config.id);
            
            closeQuickModal();
            
            // Mensaje de √©xito
            addMessage('assistant', `¬°Configuraci√≥n exitosa! Ahora est√°s usando ${configName}. ${model.includes(':free') ? 'Este es un modelo gratuito.' : ''} ¬°Puedes empezar a chatear!`);
        }

        // Mostrar modal de a√±adir/editar
        function showAddModal() {
            editingConfigId = null;
            document.getElementById('modalTitle').textContent = 'A√±adir Nueva API';
            document.getElementById('configName').value = '';
            document.getElementById('provider').value = 'openrouter';
            document.getElementById('apiKey').value = '';
            document.getElementById('modelName').value = suggestedModels.openrouter;
            document.getElementById('endpoint').value = '';
            document.getElementById('customHeaders').value = '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById('configModal').classList.remove('active');
            document.getElementById('modalError').classList.remove('active');
        }

        // Actualizar campos seg√∫n el proveedor
        function updateProviderFields() {
    const provider = document.getElementById('provider').value;
    const endpointGroup = document.getElementById('endpointGroup');
    const headersGroup = document.getElementById('headersGroup');
    const apiKeyHelp = document.getElementById('apiKeyHelp');
    const modelHelp = document.getElementById('modelHelp');
    const providerInfo = document.getElementById('providerInfo');
    const examplesDiv = document.getElementById('modelExamples');

    const endpointLabel = endpointGroup.querySelector('label');
    const endpointSmall = endpointGroup.querySelector('small');
    const endpointInput = document.getElementById('endpoint');

    // Info de proveedor
    if (provider === 'openrouter') {
        providerInfo.className = 'info-box openrouter';
        providerInfo.innerHTML = `
            <strong>üöÄ OpenRouter:</strong> Una sola API key para m√∫ltiples modelos.<br>
            Obt√©n tu key en <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a><br>
            Explora modelos en <a href="https://openrouter.ai/models" target="_blank">openrouter.ai/models</a>
        `;
        providerInfo.style.display = 'block';
        apiKeyHelp.innerHTML = 'D√©jala vac√≠a si usas un Worker/Proxy (recomendado).';
        modelHelp.textContent = 'Copia el ID exacto del modelo desde openrouter.ai/models';

        // Ejemplos
        examplesDiv.innerHTML = `
            <strong>Modelos Gratuitos:</strong><br>
            ${modelExamples.openrouter.free.map(m => `‚Ä¢ ${m}`).join('<br>')}<br><br>
            <strong>Modelos Premium:</strong><br>
            ${modelExamples.openrouter.paid.map(m => `‚Ä¢ ${m}`).join('<br>')}
        `;
        examplesDiv.style.display = 'block';

        // Mostrar campo Endpoint como "Proxy CORS (opcional)"
        endpointGroup.style.display = 'block';
        headersGroup.style.display = 'none';
        endpointLabel.textContent = 'URL del Proxy CORS (opcional)';
        endpointInput.placeholder = 'https://tu-worker.workers.dev';
        endpointSmall.textContent = 'Pega la URL de tu Cloudflare Worker. D√©jalo vac√≠o para llamar directo a OpenRouter (en GitHub Pages puede fallar por CORS).';

    } else if (provider === 'openai') {
        providerInfo.className = 'info-box';
        providerInfo.innerHTML = `
            <strong>OpenAI Direct:</strong> Acceso directo a GPT-4, GPT-3.5, etc.<br>
            Obt√©n tu key en <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a>
        `;
        providerInfo.style.display = 'block';
        apiKeyHelp.innerHTML = 'Key directa de OpenAI (sk-...)';
        modelHelp.textContent = 'Ejemplos: gpt-4o, gpt-4-turbo-preview, gpt-3.5-turbo';
        examplesDiv.innerHTML = `<strong>Modelos disponibles:</strong><br>${modelExamples.openai.map(m => `‚Ä¢ ${m}`).join('<br>')}`;
        examplesDiv.style.display = 'block';

        endpointGroup.style.display = 'none';
        headersGroup.style.display = 'none';

    } else if (provider === 'custom') {
        providerInfo.style.display = 'none';
        apiKeyHelp.innerHTML = '';
        modelHelp.textContent = '';
        examplesDiv.style.display = 'none';

        endpointGroup.style.display = 'block';
        headersGroup.style.display = 'block';
        endpointLabel.textContent = 'Endpoint URL';
        endpointInput.placeholder = 'https://api.example.com/v1/chat/completions';
        endpointSmall.textContent = 'URL completa del endpoint de la API';

    } else {
        providerInfo.style.display = 'none';
        apiKeyHelp.innerHTML = '';
        modelHelp.textContent = '';
        examplesDiv.style.display = 'none';
        endpointGroup.style.display = 'none';
        headersGroup.style.display = 'none';
    }
}

        // Guardar configuraci√≥n
        function saveConfig() {
            const name = document.getElementById('configName').value.trim();
            const provider = document.getElementById('provider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const endpoint = document.getElementById('endpoint').value.trim();
            const customHeaders = document.getElementById('customHeaders').value.trim();

            // Validaci√≥n
            if (!name || !apiKey || !model) {
                showModalError('Por favor completa todos los campos requeridos');
                return;
            }

            // Validar JSON de headers si es custom
            if (provider === 'custom' && customHeaders) {
                try { JSON.parse(customHeaders); }
                catch (e) { showModalError('Los headers personalizados deben ser JSON v√°lido'); return; }
            }

            const config = {
                id: editingConfigId || generateId(),
                name,
                provider,
                apiKey,
                model,
                endpoint: endpoint || providerEndpoints[provider],
                customHeaders: customHeaders ? JSON.parse(customHeaders) : {}
            };

            if (editingConfigId) {
                const index = configs.findIndex(c => c.id === editingConfigId);
                configs[index] = config;
            } else {
                configs.push(config);
            }

            saveConfigs();
            renderConfigs();
            updateModelSelector();
            closeModal();
        }

        // Editar configuraci√≥n
        function editConfig(id) {
            const config = configs.find(c => c.id === id);
            if (!config) return;

            editingConfigId = id;
            document.getElementById('modalTitle').textContent = 'Editar Configuraci√≥n';
            document.getElementById('configName').value = config.name;
            document.getElementById('provider').value = config.provider;
            document.getElementById('apiKey').value = config.apiKey;
            document.getElementById('modelName').value = config.model;
            document.getElementById('endpoint').value = config.endpoint || '';
            document.getElementById('customHeaders').value = config.customHeaders ? JSON.stringify(config.customHeaders, null, 2) : '';
            updateProviderFields();
            document.getElementById('configModal').classList.add('active');
        }

        // Eliminar configuraci√≥n
        function deleteConfig(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta configuraci√≥n?')) return;

            configs = configs.filter(c => c.id !== id);
            saveConfigs();
            renderConfigs();
            updateModelSelector();

            if (activeConfig && activeConfig.id === id) {
                activeConfig = null;
                document.getElementById('activeModel').value = '';
                updateStatus();
            }
        }

        // Establecer modelo activo
        function setActiveModel(configId) {
            if (!configId) {
                activeConfig = null;
                updateStatus();
                return;
            }

            activeConfig = configs.find(c => c.id === configId);
            localStorage.setItem('activeModelId', configId);
            updateStatus();
        }

        // Actualizar indicador de estado
        function updateStatus() {
            const indicator = document.getElementById('statusIndicator');
            const modelName = document.getElementById('currentModelName');

            if (activeConfig) {
                indicator.className = 'status-indicator active';
                const isFree = activeConfig.model && activeConfig.model.includes(':free');
                modelName.textContent = activeConfig.name + (isFree ? ' (GRATIS)' : '');
            } else {
                indicator.className = 'status-indicator inactive';
                modelName.textContent = 'Sin modelo seleccionado';
            }
        }

        // Event listener para cambio de modelo
        document.getElementById('activeModel').addEventListener('change', (e) => {
            setActiveModel(e.target.value);
        });

        // Manejar tecla Enter en el input
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            if (!activeConfig) {
                alert('Por favor selecciona un modelo activo primero');
                return;
            }

            // A√±adir mensaje del usuario
            addMessage('user', message);
            input.value = '';

            // Deshabilitar el bot√≥n de enviar
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;

            // Mostrar indicador de escritura
            showTypingIndicator();

            try {
                const response = await callAPI(message);
                removeTypingIndicator();
                addMessage('assistant', response);
            } catch (error) {
                removeTypingIndicator();
                addMessage('assistant', `Error: ${error.message}`);
            } finally {
                sendButton.disabled = false;
            }
        }

        // Llamar a la API
        async function callAPI(message) {
            const config = activeConfig;

            // Preparar el cuerpo de la petici√≥n seg√∫n el proveedor
            let body, headers, url;

            switch (config.provider) {
                case 'openrouter':
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Universal AI Chat'
                    };
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }]),
                        max_tokens: 4096,
                        temperature: 0.7
                    };
                    break;

                case 'anthropic':
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'x-api-key': config.apiKey,
                        'anthropic-version': '2023-06-01'
                    };
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }]),
                        max_tokens: 1024
                    };
                    break;

                case 'google':
                    url = config.endpoint.replace('{model}', config.model) + '?key=' + config.apiKey;
                    headers = { 'Content-Type': 'application/json' };
                    body = { contents: [{ parts: [{ text: message }] }] };
                    break;

                case 'custom':
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        ...config.customHeaders
                    };
                    if (!headers.Authorization && config.apiKey) {
                        headers.Authorization = `Bearer ${config.apiKey}`;
                    }
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }])
                    };
                    break;

                default: // openai, groq, together
                    url = config.endpoint;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    };
                    body = {
                        model: config.model,
                        messages: messages.concat([{ role: 'user', content: message }])
                    };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`API Error (${response.status}): ${error}`);
                }

                const data = await response.json();

                // Extraer la respuesta seg√∫n el formato del proveedor
                let content;
                switch (config.provider) {
                    case 'anthropic':
                        content = data.content[0].text;
                        break;
                    case 'google':
                        content = data.candidates[0].content.parts[0].text;
                        break;
                    default: // openrouter, openai, groq, together
                        content = data.choices[0].message.content;
                }

                // Actualizar historial de mensajes
                messages.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content }
                );

                return content;
            } catch (error) {
                console.error('API Error:', error);
                
                // Mensaje de error m√°s descriptivo para OpenRouter
                if (config.provider === 'openrouter' && error.message.includes('401')) {
                    throw new Error('API key inv√°lida. Verifica tu key de OpenRouter en openrouter.ai/keys');
                } else if (config.provider === 'openrouter' && error.message.includes('429')) {
                    throw new Error('L√≠mite de rate excedido. Espera un momento o usa un modelo gratuito.');
                }
                
                throw error;
            }
        }

        // A√±adir mensaje al chat
        function addMessage(role, content) {
            const container = document.getElementById('chatContainer');
            
            // Limpiar el mensaje de bienvenida si existe
            if (container.querySelector('div[style*="text-align: center"]')) {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'U' : 'AI';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(content);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Formatear mensaje (Markdown b√°sico)
        function formatMessage(content) {
            content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');      // Escapar HTML
            content = content.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>'); // Code blocks
            content = content.replace(/`([^`]+)`/g, '<code>$1</code>');                     // Inline code
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');            // Bold
            content = content.replace(/\*(.*?)\*/g, '<em>$1</em>');                        // Italic
            content = content.replace(/\n/g, '<br>');                                      // Line breaks
            return content;
        }

        // Indicador de escritura
        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(indicator);
            container.scrollTop = container.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function showModalError(message) {
            const errorDiv = document.getElementById('modalError');
            errorDiv.textContent = message;
            errorDiv.classList.add('active');
            setTimeout(() => errorDiv.classList.remove('active'), 5000);
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', init);

        // Registro del Service Worker + aviso de actualizaci√≥n
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('Service Worker registrado');
                        if (reg.waiting) promptUpdate(reg);
                        reg.addEventListener('updatefound', () => {
                            const newSW = reg.installing;
                            if (!newSW) return;
                            newSW.addEventListener('statechange', () => {
                                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                                    promptUpdate(reg);
                                }
                            });
                        });
                    })
                    .catch(err => console.error('SW registration failed:', err));
            });
        }

        function promptUpdate(reg) {
            const bar = document.createElement('div');
            bar.style.cssText = `
                position:fixed;left:50%;transform:translateX(-50%);bottom:16px;
                background:#1e293b;color:#fff;border:1px solid #475569;border-radius:12px;
                padding:10px 14px;display:flex;gap:10px;align-items:center;z-index:9999;`;
            bar.innerHTML = `
                <span>Nueva versi√≥n disponible</span>
                <button style="background:#6366f1;border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;">
                    Actualizar
                </button>`;
            bar.querySelector('button').onclick = () => {
                reg.waiting.postMessage({ type: 'SKIP_WAITING' });
            };
            document.body.appendChild(bar);

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>